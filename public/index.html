<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>COLART - Desenho Colaborativo</title>
<link rel="icon" href="favicon.ico">
<style>
  /* Reset e estilo geral */
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
  body { display:flex; flex-direction:column; height:100vh; background:#0a0a0a; color:#fff; overflow:hidden; }

  /* Toolbar futurista */
  #toolbar {
    display:flex; gap:10px; align-items:center; padding:10px;
    background: linear-gradient(90deg, #1c1c1c, #2a2a2a);
    border-bottom: 2px solid #00fff7;
  }
  #toolbar input, #toolbar button {
    padding:5px 10px; border:none; border-radius:5px; outline:none;
    background:#1c1c1c; color:#00fff7; font-weight:bold;
  }
  #toolbar input::placeholder { color:#555; }
  #toolbar button:hover { background:#00fff7; color:#000; cursor:pointer; }

  /* Canvas principal */
  #canvas { flex:1; background:#101010; cursor:crosshair; display:block; }

  /* Painel de usuários */
  #userList {
    position:absolute; top:70px; right:10px; width:200px;
    background:rgba(0,0,0,0.6); border:1px solid #00fff7; border-radius:5px;
    padding:10px; max-height:300px; overflow-y:auto;
  }
  #userList h3 { margin-bottom:10px; font-size:16px; text-align:center; }
  #userList div { padding:5px; border-bottom:1px solid #00fff7; }
</style>
</head>
<body>

<div id="toolbar">
  <input type="text" id="nick" placeholder="Seu nick (opcional)">
  <input type="text" id="roomCode" placeholder="Código da sala">
  <button id="createRoomBtn">Criar Sala</button>
  <button id="joinRoomBtn">Entrar</button>
  <button id="randomRoomBtn">Sala Aleatória</button>
  <input type="color" id="colorPicker" value="#00fff7">
  <input type="number" id="sizePicker" value="3" min="1" max="15">
</div>

<canvas id="canvas"></canvas>

<div id="userList">
  <h3>Usuários na sala</h3>
  <div id="usersContainer"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// --- SUPABASE CONFIG ---
const supabaseUrl = 'https://endmojdqpnmxfapmtxik.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZG1vamRxcG5teGZhcG10eGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NzgxMjUsImV4cCI6MjA3OTI1NDEyNX0.HMZYxnIsUDC93qjdG0LKbZMT6w0g9DwJ1-tDEaaHNvc'
const supabase = createClient(supabaseUrl, supabaseKey)

let roomId, userId, nickname, strokePath = []

const canvas = document.getElementById('canvas')
const ctx = canvas.getContext('2d')
const usersContainer = document.getElementById('usersContainer')

// Ajustar canvas para o tamanho da tela
function resizeCanvas() {
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight - document.getElementById('toolbar').offsetHeight
}
window.addEventListener('resize', resizeCanvas)
resizeCanvas()

const colorPicker = document.getElementById('colorPicker')
const sizePicker = document.getElementById('sizePicker')

// ======== SALAS ========

// Criar Sala
document.getElementById('createRoomBtn').onclick = async () => {
  const code = Math.random().toString(36).substr(2, 6).toUpperCase()
  const { data, error } = await supabase.from('rooms').insert({ code }).select()
  if(data && data.length) joinRoom(data[0].id)
  else alert('Erro ao criar sala!')
}

// Entrar por Código
document.getElementById('joinRoomBtn').onclick = async () => {
  const code = document.getElementById('roomCode').value.toUpperCase()
  const { data } = await supabase.from('rooms').select().eq('code', code)
  if(data.length) joinRoom(data[0].id)
  else alert('Sala não encontrada!')
}

// Sala Aleatória
document.getElementById('randomRoomBtn').onclick = async () => {
  const { data } = await supabase.from('rooms').select().order('created_at', {ascending:true}).limit(1)
  if(data.length) joinRoom(data[0].id)
  else alert('Nenhuma sala disponível!')
}

// Entrar na sala
async function joinRoom(id) {
  roomId = id
  nickname = document.getElementById('nick').value || 'colabeiro'
  
  // Criar usuário
  const { data:userData } = await supabase.from('users').insert({ nick: nickname }).select()
  userId = userData[0].id
  
  // Obter usuários já na sala
  const { data:roomUsers } = await supabase.from('room_users').select().eq('room_id', roomId)
  const order = roomUsers.length + 1
  const finalNick = nickname === 'colabeiro' ? `colabeiro${order}` : nickname
  
  // Inserir na sala
  await supabase.from('room_users').insert({
    room_id: roomId,
    user_id: userId,
    nickname: finalNick,
    order_in_room: order
  })

  updateUserList()
  
  // Escuta de traços em tempo real
  supabase.channel(`room-${roomId}`)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'strokes', filter: `room_id=eq.${roomId}` }, payload => {
      drawStroke(payload.new)
    }).subscribe()
  
  alert(`Entrou na sala! Seu nick: ${finalNick}`)
}

// Atualiza lista de usuários na sala
async function updateUserList() {
  const { data:users } = await supabase.from('room_users').select().eq('room_id', roomId).order('order_in_room')
  usersContainer.innerHTML = ''
  users.forEach(u => {
    const div = document.createElement('div')
    div.textContent = u.nickname
    usersContainer.appendChild(div)
  })
}

// ======== DESENHO ========

canvas.onpointerdown = (e) => { strokePath = [{x:e.offsetX, y:e.offsetY}] }
canvas.onpointermove = (e) => {
  if(strokePath.length) {
    strokePath.push({x:e.offsetX, y:e.offsetY})
    drawLine(strokePath, colorPicker.value, sizePicker.value)
  }
}
canvas.onpointerup = async () => {
  if(strokePath.length) {
    await supabase.from('strokes').insert({
      room_id: roomId,
      user_id: userId,
      color: colorPicker.value,
      size: sizePicker.value,
      path: strokePath
    })
    strokePath = []
  }
}

// Funções de desenho
function drawLine(path, color, size) {
  if(path.length < 2) return
  ctx.strokeStyle = color
  ctx.lineWidth = size
  ctx.lineCap = 'round'
  ctx.beginPath()
  ctx.moveTo(path[0].x, path[0].y)
  for(let i=1; i<path.length; i++) ctx.lineTo(path[i].x, path[i].y)
  ctx.stroke()
}

function drawStroke(stroke) {
  drawLine(stroke.path, stroke.color, stroke.size)
}
</script>

</body>
</html>
